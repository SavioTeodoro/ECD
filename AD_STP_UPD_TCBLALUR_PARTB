CREATE OR REPLACE PROCEDURE "AD_STP_UPD_TCBLALUR_PARTB" (
       P_CODUSU NUMBER,        
       P_IDSESSAO VARCHAR2,    
       P_QTDLINHAS NUMBER,     
       P_MENSAGEM OUT VARCHAR2 
) AS
       FIELD_CONTAPARTEB FLOAT;
       PARAM_REFERENCIA DATE;       
       V_NUMLANC NUMBER;
       V_CODCTACTB NUMBER;
       V_CODEMP NUMBER;
       V_DATAINI DATE;
       V_DATALIM DATE;
       V_TIPTRIB VARCHAR2(1);
	   V_CODIGO VARCHAR2(100);
       V_SALDOANO NUMBER;
       V_SALDOSOMA NUMBER;
       V_COUNT NUMBER;
       V_SALDOINI NUMBER;
       V_SALDOINISOMA NUMBER;
       V_SALDOFINSOMA NUMBER;

BEGIN
       PARAM_REFERENCIA := ACT_DTA_PARAM(P_IDSESSAO, 'REFERENCIA');


       FOR I IN 1..P_QTDLINHAS 
       LOOP                    
           FIELD_CONTAPARTEB := ACT_DEC_FIELD(P_IDSESSAO, I, 'CONTAPARTEB');

       SELECT NVL(MAX(NUMLANC),0) INTO V_NUMLANC
       FROM AD_TCBLALURLANC 
       WHERE CONTAPARTEB = FIELD_CONTAPARTEB;


       SELECT SUM(SAL.SALDOINICMES) INTO V_SALDOANO
       FROM
        VW_TCBLAN_ENC_RESUL L
        INNER JOIN TCBPLA P ON P.CODCTACTB = L.CODCTACTB
        INNER JOIN TCBSAL SAL ON SAL.CODCTACTB = P.CODCTACTB 
        WHERE SAL.REFERENCIA = TO_DATE('01/01/' || TO_CHAR(TO_DATE(PARAM_REFERENCIA, 'DD/MM/YYYY'), 'YYYY'), 'DD/MM/YYYY')
            AND L.CODEMP = V_CODEMP
            AND P.CODLALURB = V_CODIGO;

       SELECT  CODEMP, DATAINI,
              DATALIM, TIPTRIB, CODIGO
       INTO  V_CODEMP, V_DATAINI,
              V_DATALIM, V_TIPTRIB, V_CODIGO
       FROM AD_TCBLALUR
       WHERE CONTAPARTEB = FIELD_CONTAPARTEB;

       INSERT INTO AD_TCBLALURLANC
       (NUMLANC,
        CONTAPARTEB,
       REFERENCIA,
       CODCTACTB,
       VALOR, 
       DC,
       REFLEXO,
       TIPOIMPOSTO) 

       SELECT
    V_NUMLANC + RN AS NUMLANC,
    FIELD_CONTAPARTEB,
    V_DATAINI,
    CODCTACTB,
    SUM(VLRLANC) AS VLRLANC,
    TIPLANC AS TIPOIMPOSTO,
    'N' AS REFLEXO,
    'I' AS TIPOIMPOSTO
FROM
    (SELECT
        V_NUMLANC, 
        ROW_NUMBER() OVER (ORDER BY V_NUMLANC) AS RN,
        FIELD_CONTAPARTEB,
        V_DATAINI,
        L.CODCTACTB,
        L.TIPLANC,
         ABS(SUM(SAL.DEBMES) - SUM(SAL.CREDMES) - V_SALDOANO) AS VLRLANC
    FROM
        VW_TCBLAN_ENC_RESUL L
        INNER JOIN TCBPLA P ON P.CODCTACTB = L.CODCTACTB
        INNER JOIN TCBSAL SAL ON SAL.CODCTACTB = P.CODCTACTB
    WHERE SAL.REFERENCIA = PARAM_REFERENCIA
        AND L.CODEMP = V_CODEMP
        AND P.CODLALURB = V_CODIGO
    GROUP BY
        V_NUMLANC,
        FIELD_CONTAPARTEB,
        V_DATAINI,
        L.CODCTACTB,
        L.TIPLANC) Subquery
GROUP BY
    V_NUMLANC + RN,
    FIELD_CONTAPARTEB,
    V_DATAINI,
    CODCTACTB,
    TIPLANC;

	SELECT NVL(MAX(NUMLANC),0) INTO V_NUMLANC
       FROM AD_TCBLALURLANC 
       WHERE CONTAPARTEB = FIELD_CONTAPARTEB;


    INSERT INTO AD_TCBLALURLANC
       (NUMLANC,
        CONTAPARTEB,
       REFERENCIA,
       CODCTACTB,
       VALOR, 
       DC,
       REFLEXO,
       TIPOIMPOSTO) 

       SELECT
    V_NUMLANC + RN AS NUMLANC,
    FIELD_CONTAPARTEB,
    V_DATAINI,
    CODCTACTB,
    SUM(VLRLANC) AS VLRLANC,
    TIPLANC AS TIPOIMPOSTO,
    'N' AS REFLEXO,
    'C' AS TIPOIMPOSTO
FROM
    (SELECT
        V_NUMLANC,
        ROW_NUMBER() OVER (ORDER BY V_NUMLANC) AS RN,
        FIELD_CONTAPARTEB,
        V_DATAINI,
        L.CODCTACTB,
        L.TIPLANC,
         ABS(SUM(SAL.DEBMES) - SUM(SAL.CREDMES) - V_SALDOANO) AS VLRLANC
    FROM
        VW_TCBLAN_ENC_RESUL L
        INNER JOIN TCBPLA P ON P.CODCTACTB = L.CODCTACTB
        INNER JOIN TCBSAL SAL ON SAL.CODCTACTB = P.CODCTACTB
    WHERE SAL.REFERENCIA = PARAM_REFERENCIA
        AND L.CODEMP = V_CODEMP
        AND P.CODLALURB = V_CODIGO
    GROUP BY
        V_NUMLANC,
        FIELD_CONTAPARTEB,
        V_DATAINI,
        L.CODCTACTB,
        L.TIPLANC) Subquery
GROUP BY
    V_NUMLANC + RN,
    FIELD_CONTAPARTEB,
    V_DATAINI,
    CODCTACTB,
    TIPLANC;



------------------------------------------------------------


    SELECT COUNT(1) 
        INTO V_COUNT 
    FROM AD_TCBLALURSAL 
    WHERE CONTAPARTEB = FIELD_CONTAPARTEB 
        AND REFERENCIA = PARAM_REFERENCIA;

    SELECT NVL(SUM(NVL(SALDOFIN, 0)), 0) 
        INTO V_SALDOINI 
    FROM AD_TCBLALURSAL 
    WHERE CONTAPARTEB = FIELD_CONTAPARTEB 
        AND REFERENCIA = ADD_MONTHS(PARAM_REFERENCIA,-1);

    SELECT (SUM(SAL.DEBMES) - SUM(SAL.CREDMES) - V_SALDOANO)
        INTO V_SALDOSOMA
    FROM
        VW_TCBLAN_ENC_RESUL L
        INNER JOIN TCBPLA P ON P.CODCTACTB = L.CODCTACTB
        INNER JOIN TCBSAL SAL ON SAL.CODCTACTB = P.CODCTACTB
    WHERE SAL.REFERENCIA = PARAM_REFERENCIA
        AND L.CODEMP = V_CODEMP
        AND P.CODLALURB = V_CODIGO;

    SELECT SALDOINI, SALDOFIN INTO V_SALDOINISOMA, V_SALDOFINSOMA
    FROM AD_TCBLALURSAL 
    WHERE CONTAPARTEB = FIELD_CONTAPARTEB 
        AND REFERENCIA = PARAM_REFERENCIA;    


        IF V_COUNT = 0 THEN 
            INSERT INTO AD_TCBLALURSAL (CONTAPARTEB, REFERENCIA, SALDOINI, SALDOFIN)
            VALUES  (FIELD_CONTAPARTEB, PARAM_REFERENCIA, NVL(V_SALDOINI,0) + NVL(V_SALDOINISOMA,0), NVL(V_SALDOINI,0) + NVL(V_SALDOSOMA,0) + NVL(V_SALDOFINSOMA,0));
        END IF;

        IF V_COUNT >= 1 THEN
            UPDATE AD_TCBLALURSAL SET SALDOINI = NVL(V_SALDOINI,0)+NVL(V_SALDOINISOMA,0) , SALDOFIN = NVL(V_SALDOINI ,0)+ NVL(V_SALDOSOMA,0)+NVL(V_SALDOFINSOMA,0)
            WHERE CONTAPARTEB = FIELD_CONTAPARTEB 
            AND REFERENCIA = PARAM_REFERENCIA;
        END IF;

    END LOOP;
END;




/
