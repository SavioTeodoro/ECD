CREATE OR REPLACE PROCEDURE "AD_STP_UPD_TCBLALUR_PARTB" (
       P_CODUSU NUMBER,        
       P_IDSESSAO VARCHAR2,    
       P_QTDLINHAS NUMBER,     
       P_MENSAGEM OUT VARCHAR2 
) AS
       FIELD_CONTAPARTEB FLOAT;
       V_NUMLANC NUMBER;
       V_CODCTACTB NUMBER;
       V_CODEMP NUMBER;
       V_DATAINI DATE;
       V_DATALIM DATE;
       V_TIPTRIB VARCHAR2(1);

BEGIN


       FOR I IN 1..P_QTDLINHAS 
       LOOP                    
           FIELD_CONTAPARTEB := ACT_DEC_FIELD(P_IDSESSAO, I, 'CONTAPARTEB');

       SELECT NVL(MAX(NUMLANC),1) INTO V_NUMLANC
       FROM AD_TCBLALURLANC 
       WHERE CONTAPARTEB = FIELD_CONTAPARTEB;

       SELECT  CODEMP, DATAINI,
              DATALIM, TIPTRIB
       INTO  V_CODEMP, V_DATAINI,
              V_DATALIM, V_TIPTRIB
       FROM AD_TCBLALUR
       WHERE CONTAPARTEB = FIELD_CONTAPARTEB;

       INSERT INTO AD_TCBLALURLANC
       (NUMLANC,
       REFERENCIA,
       CODCTACTB,
       VALOR, 
       DC,
       REFLEXO,
       TIPOIMPOSTO) 

       SELECT V_NUMLANC,
              V_DATAINI,
              L.CODCTACTB,
              ABS(SUM(CASE WHEN L.TIPLANC = 'D' THEN L.VLRLANC ELSE L.VLRLANC * -1 END)) AS VLRLANC,
              L.TIPLANC AS TIPOIMPOSTO,
              'N' AS REFLEXO,
              'I' AS TIPOIMPOSTO
       FROM VW_TCBLAN_ENC_RESUL L
       INNER JOIN TCBPLA P
       ON (P.CODCTACTB = L.CODCTACTB)
       WHERE NVL(P.ADICOESIRPJ, 'N') = 'S'
       AND L.REFERENCIA BETWEEN V_DATAINI AND V_DATALIM
       AND L.CODEMP = V_CODEMP
       AND P.CODLALURB = FIELD_CONTAPARTEB
       GROUP BY L.CODEMP,
       L.CODCTACTB ,
       L.TIPLANC

       UNION ALL

       SELECT V_NUMLANC,
              V_DATAINI,
              L.CODCTACTB,
              ABS(SUM(CASE WHEN L.TIPLANC = 'D' THEN L.VLRLANC ELSE L.VLRLANC * -1 END)) AS VLRLANC,
              L.TIPLANC AS TIPOIMPOSTO,
              'N' AS REFLEXO,
              'C' AS TIPOIMPOSTO
       FROM VW_TCBLAN_ENC_RESUL L
       INNER JOIN TCBPLA P
       ON (P.CODCTACTB = L.CODCTACTB)
       WHERE NVL(P.ADICOESCSLL, 'N') = 'S'
       AND L.REFERENCIA BETWEEN V_DATAINI AND V_DATALIM
       AND L.CODEMP = V_CODEMP
       AND P.CODLALURB = FIELD_CONTAPARTEB
       GROUP BY L.CODEMP,
       L.CODCTACTB ,
       L.TIPLANC;

--------------------------------------------------------------------------------


       INSERT INTO AD_TCBLALURLANC
       (NUMLANC,
       REFERENCIA,
       CODCTACTB,
       VALOR, 
       DC,
       REFLEXO,
       TIPOIMPOSTO) 

       SELECT V_NUMLANC,
              V_DATAINI,
              L.CODCTACTB,
              ABS(SUM(CASE WHEN L.TIPLANC = 'D' THEN L.VLRLANC ELSE L.VLRLANC * -1 END)) AS VLRLANC,
              L.TIPLANC AS TIPOIMPOSTO,
              'N' AS REFLEXO,
              'I' AS TIPOIMPOSTO
       FROM VW_TCBLAN_ENC_RESUL L
       INNER JOIN TCBPLA P
       ON (P.CODCTACTB = L.CODCTACTB)
       WHERE NVL(P.EXCLUSOESIRPJ, 'N') = 'S'
       AND L.REFERENCIA BETWEEN V_DATAINI AND V_DATALIM
       AND L.CODEMP = V_CODEMP
       AND P.CODLALURB = FIELD_CONTAPARTEB
       GROUP BY L.CODEMP,
       L.CODCTACTB ,
       L.TIPLANC

       UNION ALL

       SELECT V_NUMLANC,
              V_DATAINI,
              L.CODCTACTB,
              ABS(SUM(CASE WHEN L.TIPLANC = 'D' THEN L.VLRLANC ELSE L.VLRLANC * -1 END)) AS VLRLANC,
              L.TIPLANC AS TIPOIMPOSTO,
              'N' AS REFLEXO,
              'C' AS TIPOIMPOSTO
       FROM VW_TCBLAN_ENC_RESUL L
       INNER JOIN TCBPLA P
       ON (P.CODCTACTB = L.CODCTACTB)
       WHERE NVL(P.EXCLUSOESCSLL, 'N') = 'S'
       AND L.REFERENCIA BETWEEN V_DATAINI AND V_DATALIM
       AND L.CODEMP = V_CODEMP
       AND P.CODLALURB = FIELD_CONTAPARTEB
       GROUP BY L.CODEMP,
       L.CODCTACTB ,
       L.TIPLANC;



       END LOOP;
END;

/
