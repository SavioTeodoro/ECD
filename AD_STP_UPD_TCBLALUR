CREATE OR REPLACE PROCEDURE "AD_STP_UPD_TCBLALUR" (
       P_CODUSU NUMBER,        
       P_IDSESSAO VARCHAR2,    
       P_QTDLINHAS NUMBER,     
       P_MENSAGEM OUT VARCHAR2 
) AS
       FIELD_CONTAPARTEB FLOAT;
       PARAM_REFERENCIA DATE;
       V_NUMLANC NUMBER;
       V_NUMLANC2 NUMBER;       
       V_CODCTACTB NUMBER;
       V_CODEMP NUMBER;
       V_DATAINI DATE;
       V_DATALIM DATE;
       V_TIPTRIB VARCHAR2(1);
       V_COUNT NUMBER;
       V_ADICOES NUMBER;
       V_EXCLUSOES NUMBER;
       V_CHECAGEM NUMBER;
       V_CHECAGEM2 NUMBER;


       V_SALDOINI NUMBER;
BEGIN

       PARAM_REFERENCIA := ACT_DTA_PARAM(P_IDSESSAO, 'REFERENCIA');
       FOR I IN 1..P_QTDLINHAS 
       LOOP                    
           FIELD_CONTAPARTEB := ACT_DEC_FIELD(P_IDSESSAO, I, 'CONTAPARTEB');

       SELECT NVL(MAX(NUMLANC),0) INTO V_NUMLANC
       FROM AD_TCBLALURLANC 
       WHERE CONTAPARTEB = FIELD_CONTAPARTEB;

       SELECT COUNT(1) INTO V_CHECAGEM
       FROM AD_TCBLALURLANC 
       WHERE CONTAPARTEB = FIELD_CONTAPARTEB
       AND NUMLANC > 0
       AND REFERENCIA = PARAM_REFERENCIA;

       SELECT  CODEMP, DATAINI,
              DATALIM, TIPTRIB
       INTO  V_CODEMP, V_DATAINI,
              V_DATALIM, V_TIPTRIB
       FROM AD_TCBLALUR
       WHERE CONTAPARTEB = FIELD_CONTAPARTEB;


       IF V_CHECAGEM > 0 OR V_CHECAGEM2 > 0 THEN 
       RAISE_APPLICATION_ERROR(-20001, 'Apuração já executada');
       END IF;

       INSERT INTO AD_TCBLALURLANC
       (NUMLANC,
       CONTAPARTEB,
       REFERENCIA,
       CODCTACTB,
       VALOR, 
       DC,
       REFLEXO,
       TIPOIMPOSTO) 

        SELECT V_NUMLANC + ROW_NUMBER() OVER (ORDER BY V_NUMLANC) AS V_NUMLANC,
              FIELD_CONTAPARTEB,
              PARAM_REFERENCIA,
              L.CODCTACTB,
              ABS(SUM(CASE WHEN L.TIPLANC = 'D' THEN L.VLRLANC ELSE L.VLRLANC * -1 END)) AS VLRLANC,
              L.TIPLANC AS TIPOIMPOSTO,
              'N' AS REFLEXO,
              'I' AS TIPOIMPOSTO
       FROM VW_TCBLAN_ENC_RESUL L
       INNER JOIN TCBPLA P
       ON (P.CODCTACTB = L.CODCTACTB)
       WHERE NVL(P.ADICOESIRPJ, 'N') = 'S'
       AND L.REFERENCIA =PARAM_REFERENCIA
       AND L.CODEMP = V_CODEMP
       AND P.CODCONTA = FIELD_CONTAPARTEB
       GROUP BY L.CODEMP,
       L.CODCTACTB ,
       L.TIPLANC;

       INSERT INTO AD_TCBLALURLANC
       (NUMLANC,
       CONTAPARTEB,
       REFERENCIA,
       CODCTACTB,
       VALOR, 
       DC,
       REFLEXO,
       TIPOIMPOSTO) 

       SELECT V_NUMLANC + ROW_NUMBER() OVER (ORDER BY V_NUMLANC) AS V_NUMLANC,
              FIELD_CONTAPARTEB,
              PARAM_REFERENCIA,
              L.CODCTACTB,
              ABS(SUM(CASE WHEN L.TIPLANC = 'D' THEN L.VLRLANC ELSE L.VLRLANC * -1 END)) AS VLRLANC,
              L.TIPLANC AS TIPOIMPOSTO,
              'N' AS REFLEXO,
              'C' AS TIPOIMPOSTO
       FROM VW_TCBLAN_ENC_RESUL L
       INNER JOIN TCBPLA P
       ON (P.CODCTACTB = L.CODCTACTB)
       WHERE NVL(P.ADICOESCSLL, 'N') = 'S'
       AND L.REFERENCIA =PARAM_REFERENCIA
       AND L.CODEMP = V_CODEMP
       AND P.CODCONTA = FIELD_CONTAPARTEB
       GROUP BY L.CODEMP,
       L.CODCTACTB ,
       L.TIPLANC;

--------------------------------------------------------------------------------
       SELECT NVL(MAX(NUMLANC),0) INTO V_NUMLANC2
       FROM AD_TCBLALURLANC 
       WHERE CONTAPARTEB = FIELD_CONTAPARTEB;

        INSERT INTO AD_TCBLALURLANC
       (NUMLANC,
       CONTAPARTEB,
       REFERENCIA,
       CODCTACTB,
       VALOR, 
       DC,
       REFLEXO,
       TIPOIMPOSTO) 

       SELECT V_NUMLANC2 + ROW_NUMBER() OVER (ORDER BY V_NUMLANC2) AS V_NUMLANC ,
            FIELD_CONTAPARTEB,
              PARAM_REFERENCIA,
              L.CODCTACTB,
              ABS(SUM(CASE WHEN L.TIPLANC = 'D' THEN L.VLRLANC ELSE L.VLRLANC * -1 END)) AS VLRLANC,
              L.TIPLANC AS TIPOIMPOSTO,
              'N' AS REFLEXO,
              'I' AS TIPOIMPOSTO
       FROM VW_TCBLAN_ENC_RESUL L
       INNER JOIN TCBPLA P
       ON (P.CODCTACTB = L.CODCTACTB)
       WHERE NVL(P.EXCLUSOESIRPJ, 'N') = 'S'
       AND L.REFERENCIA = PARAM_REFERENCIA
       AND L.CODEMP = V_CODEMP
       AND P.CODCONTA = FIELD_CONTAPARTEB
       GROUP BY L.CODEMP,
       L.CODCTACTB,
       L.TIPLANC;

    SELECT NVL(MAX(NUMLANC),0) INTO V_NUMLANC2
       FROM AD_TCBLALURLANC 
       WHERE CONTAPARTEB = FIELD_CONTAPARTEB;

        INSERT INTO AD_TCBLALURLANC
       (NUMLANC,
       CONTAPARTEB,
       REFERENCIA,
       CODCTACTB,
       VALOR, 
       DC,
       REFLEXO,
       TIPOIMPOSTO) 

       SELECT V_NUMLANC2+ ROW_NUMBER() OVER (ORDER BY V_NUMLANC2) AS V_NUMLANC ,
              FIELD_CONTAPARTEB,
              PARAM_REFERENCIA,
              L.CODCTACTB,
              ABS(SUM(CASE WHEN L.TIPLANC = 'D' THEN L.VLRLANC ELSE L.VLRLANC * -1 END)) AS VLRLANC,
              L.TIPLANC AS TIPOIMPOSTO,
              'N' AS REFLEXO,
              'C' AS TIPOIMPOSTO
       FROM VW_TCBLAN_ENC_RESUL L
       INNER JOIN TCBPLA P ON (P.CODCTACTB = L.CODCTACTB)
       WHERE NVL(P.EXCLUSOESCSLL, 'N') = 'S'
        AND L.REFERENCIA =PARAM_REFERENCIA
        AND L.CODEMP = V_CODEMP
        AND P.CODCONTA = FIELD_CONTAPARTEB
       GROUP BY L.CODEMP,
                L.CODCTACTB ,
                L.TIPLANC;


       SELECT COUNT(1) 
            INTO V_COUNT 
       FROM AD_TCBLALURSAL 
       WHERE CONTAPARTEB = FIELD_CONTAPARTEB 
        AND REFERENCIA = PARAM_REFERENCIA;

       SELECT NVL(SUM(NVL(SALDOFIN, 0)), 0) 
            INTO V_SALDOINI 
       FROM AD_TCBLALURSAL 
       WHERE CONTAPARTEB = FIELD_CONTAPARTEB 
        AND REFERENCIA = ADD_MONTHS(PARAM_REFERENCIA,-1);

       SELECT NVL(SUM(SUM(CASE WHEN L.TIPLANC = 'D' THEN L.VLRLANC ELSE L.VLRLANC * -1 END)), 0) 
            INTO V_EXCLUSOES
       FROM VW_TCBLAN_ENC_RESUL L
            INNER JOIN TCBPLA P  ON (P.CODCTACTB = L.CODCTACTB)
       WHERE NVL(P.EXCLUSOESCSLL, 'N') = 'S'
        AND L.REFERENCIA =PARAM_REFERENCIA
        AND L.CODEMP = V_CODEMP
        AND P.CODCONTA = FIELD_CONTAPARTEB
       GROUP BY L.CODEMP,
       L.CODCTACTB ,
       L.TIPLANC;

       SELECT NVL(SUM(SUM(CASE WHEN L.TIPLANC = 'D' THEN L.VLRLANC ELSE L.VLRLANC * -1 END)), 0) 
            INTO V_ADICOES
       FROM VW_TCBLAN_ENC_RESUL L
            INNER JOIN TCBPLA P ON (P.CODCTACTB = L.CODCTACTB)
       WHERE NVL(P.ADICOESCSLL, 'N') = 'S'
        AND L.REFERENCIA =PARAM_REFERENCIA
        AND L.CODEMP = V_CODEMP
        AND P.CODCONTA = FIELD_CONTAPARTEB
       GROUP BY L.CODEMP,
       L.CODCTACTB,
       L.TIPLANC;


        IF V_COUNT = 0 THEN 
            INSERT INTO AD_TCBLALURSAL (CONTAPARTEB, REFERENCIA, SALDOINI, SALDOFIN)
            VALUES  (FIELD_CONTAPARTEB, PARAM_REFERENCIA, V_SALDOINI, ABS(V_SALDOINI) -ABS(V_EXCLUSOES) +ABS(V_ADICOES));
        END IF;

        IF V_COUNT >= 1 THEN
            UPDATE AD_TCBLALURSAL SET SALDOINI = V_SALDOINI , SALDOFIN = ABS(V_SALDOINI) -ABS(V_EXCLUSOES) +ABS(V_ADICOES)
            WHERE CONTAPARTEB = FIELD_CONTAPARTEB 
            AND REFERENCIA = PARAM_REFERENCIA;
        END IF;



       END LOOP;
END;






/
